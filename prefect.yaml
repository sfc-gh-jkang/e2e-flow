# Welcome to your prefect.yaml file! You can use this file for storing and managing
# configuration for deploying your flows. We recommend committing this file to source
# control along with your flow code.
#
# =============================================================================
# DEPLOYMENT COMMANDS
# =============================================================================
#
# Deploy ALL deployments:
#   uv run prefect deploy --all
#
# Deploy a SPECIFIC deployment by name:
#   uv run prefect deploy --name eve-market-etl
#   uv run prefect deploy --name my-test-flow-deployment
#
# Run a deployment manually:
#   uv run prefect deployment run 'load-eve-market-data/eve-market-etl'
#   uv run prefect deployment run 'my-flow/my-test-flow-deployment'
#
# List all deployments:
#   uv run prefect deployment ls
#
# =============================================================================
# GITHUB CONTAINER REGISTRY (GHCR) SETUP
# =============================================================================
#
# Before deploying (to push Docker images to GHCR):
#
# 1. Create a Personal Access Token at: https://github.com/settings/tokens
#    (Grant 'write:packages' and 'read:packages' scopes)
#
# 2. Login to GHCR:
#    export CR_PAT=your_token_here
#    echo $CR_PAT | docker login ghcr.io -u sfc-gh-jkang --password-stdin
#
# 3. Deploy (builds and pushes Docker image):
#    uv run prefect deploy --name eve-market-etl
#
# To skip Docker build/push:
#   - Use ./build-and-push-github.sh separately when needed
#   - Or temporarily set 'build: null' and 'push: null' below
#
# =============================================================================

# Check docker linux space by running: docker system df

# Generic metadata about this project
name: e2e-flow
prefect-version: 3.6.4

# build section allows you to manage and build docker images
build: 
- prefect_docker.deployments.steps.build_docker_image:
    id: build-image
    requires: prefect-docker>=0.6.6
    image_name: ghcr.io/sfc-gh-jkang/e2e-flow
    tag: latest
    dockerfile: Dockerfile
    platform: linux/amd64
  
# push section allows you to manage if and how this project is uploaded to remote locations
# Requires: docker login ghcr.io -u sfc-gh-jkang --password-stdin <<< "$CR_PAT"
push:
- prefect_docker.deployments.steps.push_docker_image:
    requires: prefect-docker>=0.6.6
    image_name: "{{ build-image.image_name }}"
    tag: "{{ build-image.tag }}"

# pull section allows you to provide instructions for cloning this project in remote locations
pull:
- prefect.deployments.steps.git_clone:
    repository: https://github.com/sfc-gh-jkang/e2e-flow.git
    branch: main
    access_token: null

# the deployments section allows you to provide configuration for deploying flows
deployments:
- name: my-test-flow-deployment
  version: main
  tags: [test]
  description: "A test flow"
  schedule: 
    cron: "0 0 * * *"
  flow_name: my_flow
  entrypoint: prefect_flows.prefect_test:my_flow
  parameters:
    name: John
  work_pool:
    name: google-vm

- name: eve-market-etl
  version: main
  tags: [eve-online, etl, market-data]
  description: "ETL flow for EVE Online market data - pulls from API, validates, and loads to Crunchy Bridge PostgreSQL"
  schedule: 
    cron: "0 6 * * *"  # Run daily at 6 AM UTC
  flow_name: load_eve_market_data
  entrypoint: prefect_test:load_eve_market_data
  parameters: {}  # Uses default (pulls fresh data from API)
  work_pool:
    name: google-vm

- name: docker-eve-market-etl
  version: main
  tags: [eve-online, etl, market-data, docker]
  description: "ETL flow for EVE Online market data - runs in Docker container on google-vm-docker work pool"
  schedule: 
    cron: "0 7 * * *"  # Run daily at 7 AM UTC
  flow_name: load_eve_market_data
  entrypoint: prefect_test:load_eve_market_data
  parameters: {}
  work_pool:
    name: google-vm-docker
    job_variables:
      image: "ghcr.io/sfc-gh-jkang/e2e-flow:latest"
      image_pull_policy: "Always"

- name: docker-cleanup
  version: main
  tags: [docker, cleanup, maintenance]
  description: "Clean up old Docker images and containers to prevent disk bloat"
  schedule: 
    cron: "0 8 * * *"  # Run daily at 8 AM UTC (after ETL flows)
  flow_name: docker_cleanup
  entrypoint: docker_cleanup:docker_cleanup
  parameters:
    keep_images: 3
    keep_containers: 10
  work_pool:
    name: google-vm  # Run on VM directly (not in Docker) - needs Docker CLI on host
